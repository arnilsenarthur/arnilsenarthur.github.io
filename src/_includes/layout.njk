<!DOCTYPE html>
<html>
<head>
    <title>{% if title %}{{ title }}{% else %}{{ personal.meta.title }}{% endif %}</title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/img/icon.png"/>
    <meta name="language" content="en">
    <meta name="description" content="{{ personal.meta.description }}">
    <meta name="robots" content="all">
    <meta name="author" content="{{ personal.name }}">
    <meta name="keywords" content="{{ personal.meta.keywords }}">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="{{ personal.meta.twitterSite }}">
    <meta name="twitter:title" content="{{ personal.meta.twitterTitle }}">
    <meta name="twitter:description" content="{{ personal.meta.twitterDescription }}">
    <meta name="twitter:image" content="{{ personal.meta.twitterImage }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Critical CSS - Load immediately -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/window.css">

    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@200;400&family=Source+Sans+3:wght@400;700&family=Unica+One&display=swap" rel="stylesheet" media="print" onload="this.media='all'">

    <!-- Fallback font styles for FOIT prevention -->
    <style>
        .window { font-family: 'Readex Pro', 'Segoe UI', Tahoma, sans-serif; }
        .game { font-family: 'Unica One', 'Impact', Arial, sans-serif; }
    </style>

    <!-- Load non-critical CSS asynchronously -->
    <link rel="preload" href="/css/game.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/css/game.css"></noscript>

    <!-- Load essential external dependencies synchronously -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Load other external scripts asynchronously -->
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" media="print" onload="this.media='all'">

    <!-- Critical scripts - load immediately -->
    <script src="/js/animations.js"></script>
    <script src="/js/background.js"></script>
    <script src="/js/landing.js"></script>
    <script src="/js/pagesystem.js"></script>

    <!-- Game scripts - lazy loaded when game is accessed -->
    <script>
        window.lazyLoadGameScripts = function() {
            if (window.gameScriptsLoaded) return;

            // Load PixiJS
            const pixiScript = document.createElement('script');
            pixiScript.src = 'https://cdn.jsdelivr.net/npm/pixi.js-legacy@5.0.2/dist/pixi-legacy.min.js';
            pixiScript.defer = true;
            document.head.appendChild(pixiScript);

            // Load Tone.js
            const toneScript = document.createElement('script');
            toneScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.34/Tone.min.js';
            toneScript.defer = true;
            document.head.appendChild(toneScript);

            // Load game.js after PixiJS and Tone.js
            const gameScript = document.createElement('script');
            gameScript.src = '/js/game.js';
            gameScript.defer = true;
            document.head.appendChild(gameScript);

            window.gameScriptsLoaded = true;
        };
    </script>
</head>

<body>
    <div class="persona-toggle-overlay">
        <div class="sliding-toggle">
            <div class="toggle-track" onclick="togglePersona()">
                <div class="toggle-slider">
                    <div class="toggle-icon game-icon">
                        <i data-lucide="gamepad-2"></i>
                    </div>
                    <div class="toggle-icon dev-icon">
                        <i data-lucide="code"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="back">
    </div>
    <div class="window">
        <div class="header">
            <div class="dot red"></div>
            <div class="dot amber"></div>
            <div class="dot green"></div>
            <a class="link" href="/arnilsen_arthur.pdf">CV</a>
            <a class="link" href="#timeline">Timeline</a>
            <a class="link" href="#feed">Feed</a>
            <a class="link" href="#projects">Projects</a>
            <a class="link" href="#skills">Skills</a>
            <a class="link" href="#contact">Contact</a>
            <a class="link" href="#">Home</a>
            <a class="link return" href="#">Back</a>
            <a class="link return-feed" href="#feed" onclick="reopenFeed()">Back</a>
        </div>
        <div class="canvas">
            <div class="menubar">
                <a class="link return-feed" href="#feed" onclick="reopenFeed()">Back</a>
                <a class="link" href="/arnilsen_arthur.pdf">CV</a>
                <a class="link" href="#timeline">Timeline</a>
                <a class="link" href="#feed">Feed</a>
                <a class="link" href="#projects">Projects</a>
                <a class="link" href="#skills">Skills</a>
                <a class="link" href="#contact">Contact</a>
                <a class="link" href="#">Home</a>
            </div>
            {{ content | safe }}
        </div>

        <!--Game-->
        <div class="content" page="game">
            <div class="minwidthwarn">
                <div class="minwidthwarninner">
                    Your screen is too small to show this content
                    <div class="tilt">
                        You can try to tilt your device sideways
                    </div>
                </div>
            </div>
            <div class="game minwidth">
                <div id="hudbg"></div>
                <div id="score">
                    0000
                </div>
                <div id="lives">

                </div>

                <div class="viewport" id="gamecanvas"></div>
                <div class="gamefooter">Click to jump/double jump</div>
                <button class="red pausegame" onclick="pauseGame()"><i data-lucide="pause"></i></button>
                <div class="menu">
                    <div class="page" id="pagecollection">
                        <h2 class="titlecollection">Collection</h2>
                        <div id="collectioncontent">
                        </div>
                        <button class="red" onclick="closeCollection()">Back</button>
                    </div>
                    <div class="page" id="pagepause">
                        <button class="audiobtn" onclick="game.setAudio(!game.getAudio()); playEffect('audioToggle')"><i
                                data-lucide="volume-2"></i></button>
                        <div class="highscore">HI 2500</div>
                        <div class="title currentscore">0201</div>
                        <button class="yellow full inverse" onclick="resumeGame(true)">Continue</button>
                    </div>
                    <div class="page" id="pageplay">
                        <button class="collectionbtn" onclick="openCollection()"><i data-lucide="book-open"></i></button>
                        <button class="audiobtn" onclick="game.setAudio(!game.getAudio()); playEffect('audioToggle')"><i
                                data-lucide="volume-2"></i></button>
                        <div class="highscore">HI 2500</div>
                        <div class="title">JumpX</div>
                        <button class="green full inverse" onclick="resumeGame()">Play</button>
                    </div>
                    <div class="page" id="pageover">
                        <button class="collectionbtn" onclick="openCollectionFromGameOver()"><i data-lucide="book-open"></i></button>
                        <button class="audiobtn" onclick="game.setAudio(!game.getAudio()); playEffect('audioToggle')"><i
                                data-lucide="volume-2"></i></button>
                        <div class="highscore">HI 2500</div>
                        <div class="title gameover">Game Over</div>
                        <button class="red full inverse" onclick="playAgain()">Play Again</button>
                    </div>
                </div>
            </div>
        </div>

        <!--Papers-->
        <div class="content" page="feed" id="papers">
            <h2>Feed</h2>
            <div id="paperscontent">
                <center>
                <div class="loadingitem"></div>
                <div class="loadingitem"></div>
                <div class="loadingitem"></div>
                </center>
            </div>
        </div>

        <div class="content" page="post" id="post">
            <div id="postcontent"></div>
        </div>
    </div>
    </div>
    <div class="footer">
        Created by {{ personal.name }}
    </div>
    <script>
        // Load secondary font asynchronously
        if (typeof WebFont !== 'undefined') {
            WebFont.load({
                google: {
                    families: ['Share Tech Mono']
                },
                active: e => {
                    console.log("font loaded!");
                }
            });
        }
    </script>
    <script>
        // Initialize persona sliding toggle
        function initPersonaToggle() {
            const path = window.location.pathname;
            const toggleTrack = $('.toggle-track');
            const toggleSlider = $('.toggle-slider');

            const lastPersonaPage = localStorage.getItem('lastPersonaPage');

            // Detect current page type
            const currentPageType = path.includes('/gamedev/')
                ? 'gamedev'
                : path.includes('/dev/')
                ? 'dev'
                : null; // home page - no persona

            const shouldAnimate =
                lastPersonaPage !== null && lastPersonaPage !== currentPageType;

            const applyState = (type) => {
                if (type === null) {
                    // Home page - remove all persona classes
                    document.body.classList.remove('game-mode', 'dev-mode');
                    toggleTrack.removeClass('game-active dev-active');
                    toggleSlider.removeClass('game-active dev-active');
                } else {
                    const isGame = type === 'gamedev';
                    document.body.classList.toggle('game-mode', isGame);
                    document.body.classList.toggle('dev-mode', !isGame);

                    toggleTrack
                        .toggleClass('game-active', isGame)
                        .toggleClass('dev-active', !isGame);

                    toggleSlider
                        .toggleClass('game-active', isGame)
                        .toggleClass('dev-active', !isGame);
                }
            };

            if (shouldAnimate) {
                // Temporarily disable all transitions
                toggleSlider.css({
                    'transition': 'none',
                    'transform': 'none'
                });
                applyState(lastPersonaPage);

                // Force reflow and allow time for DOM to update
                toggleSlider[0].offsetHeight;

                // Re-enable transitions and animate
                setTimeout(() => {
                    toggleSlider.css({
                        'transition': 'all 0.3s ease',
                        'transform': ''
                    });
                    applyState(currentPageType);
                }, 10); 
            } else {
                // Ensure no transitions for instant positioning
                toggleSlider.css('transition', 'none');
                applyState(currentPageType);

                // Re-enable transitions for future interactions
                setTimeout(() => {
                    toggleSlider.css('transition', 'all 0.3s ease');
                }, 50);
            }

            // Persist current page
            localStorage.setItem('lastPersonaPage', currentPageType);
        }


        // Function to toggle between personas
        function togglePersona() {
            const currentPath = window.location.pathname;

            if (currentPath.includes('/gamedev/')) {
                // Mark that we're navigating via toggle and save current page
                localStorage.setItem('navigatingViaToggle', 'true');
                localStorage.setItem('lastPersonaPage', 'gamedev');
                // Navigate to dev page
                window.location.href = '/dev/';
            } else {
                // Mark that we're navigating via toggle and save current page
                localStorage.setItem('navigatingViaToggle', 'true');
                localStorage.setItem('lastPersonaPage', 'dev');
                // Navigate to gamedev page
                window.location.href = '/gamedev/';
            }
        }

        // Initialize Lucide icons
        function initLucideIcons() {
            lucide.createIcons();
        }

        initAnimations();
        initBackground();
        initPersonaToggle();
        initLucideIcons();

        // Initialize navigation visibility based on current persona
        const currentPath = window.location.pathname;
        const currentPersona = currentPath.includes('/gamedev/')
            ? 'gamedev'
            : currentPath.includes('/dev/')
            ? 'dev'
            : null;
        updateNavigationVisibility(currentPersona);

        // Default to home page if no hash is present
        const initialPage = window.location.hash.substring(1) || '';
        onOpenPage(initialPage);

        $("#score").on("animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd",
            function () {
                $(this).removeClass("blink");
            }
        );

        $(".canvas").scroll(function () {
            updateView();
        });

        $(window).resize(function () {
            updateView();
        });

        function updateView() {
            let h = $(window).height();
            let n = $(".timeline.data");
            n.each(function (i) {
                let dso = Math.abs($(this).position().top) / 2;

                if (i > 1)
                    dso = 99999;
                if (i >= n.length - 2)
                    dso = 0;

                let center = h / 3;

                let ds = Math.abs($(this).offset().top - center);
                let l = ((ds < dso ? ds : dso) - 100) / (h / 4);

                l = l > 1 ? 1 : (l < 0 ? 0 : l);

                if ($(this).hasClass('left'))
                    $(this).attr('style', `opacity: ${(1 - l)};transform:translate(${l * -400}px,-50%)`);
                else
                    $(this).attr('style', `opacity: ${(1 - l)};transform:translate(${l * 400}px,-50%)`);
            });

            let discount = $(".menubar").height() + $(".header").height();

            let amount = ($(window).height() - discount) * 0.8 - 50;
            $("#papers").css('max-height', `${amount}px`);
            $("#post").css('max-height', `${amount}px`);
        }

        $(window).on('orientationchange', () => {
            updateOrientation();
        })

        function updateOrientation() {
            console.log(window.orientation);
            $(".tilt").css('display', window.orientation == 0 ? 'block' : 'none');
            // Only call pauseGame if it's available (game is loaded)
            if (typeof pauseGame === 'function') {
                pauseGame();
            }
        }

        $(window).on('hashchange', function () {
            if (window.location.hash == '#bozzivagabundo') {
                setTimeout(function () {
                    window.location.replace('https://drive.google.com/drive/folders/1xw5u30Z8he7C2rHt1hPRFx7383l3vYei?usp=sharing');
                }, 5000);
            }
        });

        updateOrientation();
        updateView();
    </script>

    <!-- Full Screen Image Viewer -->
    <div id="fullscreen-image-viewer" class="fullscreen-image-viewer" style="display: none;">
        <div class="fullscreen-overlay" onclick="closeFullscreenImage()"></div>
        <div class="fullscreen-content">
            <img id="fullscreen-image" class="fullscreen-image" src="" alt="">
            <button class="fullscreen-close" onclick="closeFullscreenImage()">Ã—</button>
        </div>
    </div>
</body>
</html>
