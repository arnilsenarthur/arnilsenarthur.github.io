import*as THREE from"https://unpkg.com/three@0.169.0/build/three.module.js";import{GLTFLoader}from"https://unpkg.com/three@0.169.0/examples/jsm/loaders/GLTFLoader.js";export function init3DTimeline(e){const t=document.getElementById("timeline-canvas-container"),a=document.querySelector(".canvas");if(!t||!a)return console.error("Timeline containers not found"),null;if(!e||!Array.isArray(e))return console.error("Invalid timeline data"),t.innerHTML="Error loading timeline data.",null;try{t.innerHTML="";const o=document.createElement("div");o.className="timeline-loader",o.innerHTML='<div class="timeline-loader-inner"><div class="timeline-loader-text">Loading...</div><div class="timeline-loader-bar" aria-hidden="true"><div class="timeline-loader-bar-fill"></div></div><div class="timeline-loader-percent" aria-hidden="true">0%</div></div>',t.appendChild(o);const s=o.querySelector(".timeline-loader-bar-fill"),i=o.querySelector(".timeline-loader-percent");let l=0;const c=e=>Math.max(0,Math.min(1,e)),d=()=>{if(!s)return;const e=c(l>0?(l-ge)/l:0);s.style.transform=`scaleX(${e})`,i&&(i.textContent=`${Math.floor(100*e)}%`)};let m=null,p=null,h="",u=0,f=0,E=!1;const g=()=>{if(E)return;("undefined"!=typeof performance?performance.now():Date.now())<f||(E=!0,m&&m.classList.add("is-hidden"))},y=Date.now()%1e4;let M=y;const w={w:!1,a:!1,s:!1,d:!1,arrowup:!1,arrowdown:!1,arrowleft:!1,arrowright:!1};let v=!1,T=!0,x=!1,R=new THREE.Vector3,H=0,D=0,S=0;const b=1,V=.02,z=.95;let A=new THREE.Vector3,C=!1,P=new THREE.Vector3(0,1,0);const L=.4;let F=0,W=!1,k=!1;const q=new THREE.Vector3,j=new THREE.Vector3(0,0,-1),O=.25,N=new THREE.Raycaster,B=new THREE.Vector3(0,-1,0),_=new THREE.Vector3,$=new THREE.Vector3,G=new THREE.Vector3,I=new THREE.Vector3,U=new THREE.Vector3,X=new THREE.Vector3,Y=new THREE.Vector3,Q=new THREE.Vector3,J=new THREE.Vector3,K=new THREE.Vector3,Z=new THREE.Vector3,ee=new THREE.Vector3,te=new THREE.Vector3,ae=new THREE.Vector3,ne=new THREE.Vector3,re=new THREE.Vector3,oe=new THREE.Vector3(0,0,-1),se=()=>(M=(9301*M+49297)%233280,M/233280),ie=({create:e,onAcquire:t,onRelease:a,initialSize:n=0})=>{const r=[];for(let t=0;t<n;t++){const t=e();t&&(a&&a(t),r.push(t))}return{acquire:()=>{const a=r.pop()??e();return a?(t&&t(a),a):null},release:e=>{e&&(a&&a(e),r.push(e))}}},le=new THREE.Scene,ce=Math.max(1,t.clientWidth),de=Math.max(1,t.clientHeight),me=new THREE.PerspectiveCamera(60,ce/de,.1,1e3),pe=window.matchMedia("(max-width: 768px)").matches,he=new THREE.WebGLRenderer({antialias:!pe,alpha:!0,powerPreference:"high-performance"});he.setSize(ce,de),he.setPixelRatio(Math.min(window.devicePixelRatio||1,pe?1.5:2)),he.domElement.style.opacity="0",he.domElement.style.transition="opacity 600ms ease",he.domElement.style.position="absolute",he.domElement.style.top="0",he.domElement.style.left="0",t.appendChild(he.domElement);let ue=!1,fe=0,Ee=!1,ge=0,ye=!1,Me=0;const we=()=>{const e=t.clientWidth,a=t.clientHeight;return!(e<=0||a<=0)&&(me.aspect=e/a,me.updateProjectionMatrix(),he.setSize(e,a),he.setPixelRatio(Math.min(window.devicePixelRatio||1,pe?1.5:2)),!0)},ve=()=>{ue||Ee||(Ee=!0,Me&&(clearTimeout(Me),Me=0),requestAnimationFrame(()=>{ue||(we(),he.domElement.style.opacity="1",s&&(s.style.transform="scaleX(1)"),i&&(i.textContent="100%"),o.style.opacity="0",setTimeout(()=>{ue||o.parentNode&&o.parentNode.removeChild(o)},350),Et(),m&&!E&&m.classList.remove("is-hidden"))}))},Te=()=>{ue||Ee||(we()?ve():requestAnimationFrame(Te))},xe=()=>{ye=!0,ge++,l++,d();let e=!1;return()=>{e||(e=!0,ge=Math.max(0,ge-1),d(),ye&&0===ge&&Te())}};Me=window.setTimeout(()=>{Te()},4e3);const Re=e=>{const t=e.key.toLowerCase();w.hasOwnProperty(t)&&(w[t]=!0,g(),e.preventDefault())},He=e=>{const t=e.key.toLowerCase();w.hasOwnProperty(t)&&(w[t]=!1,e.preventDefault())};window.addEventListener("keydown",Re),window.addEventListener("keyup",He),le.add(me);const De=[],Se=80;let be=new THREE.Vector3(0,0,10);De.push(be.clone());const Ve=e.length,ze=10,Ae=Ve/(Ve+ze-1),Ce=document.createElement("div");Ce.className="timeline-ui-overlay",t.parentNode?.appendChild(Ce);const Pe=document.createElement("div");Pe.className="timeline-drag-layer",Ce.appendChild(Pe);const Le=document.createElement("div");Le.className="timeline-progress is-hidden";const Fe=document.createElement("div");Fe.className="timeline-progress-viewport";const We=document.createElement("div");We.className="timeline-progress-inner";const ke=document.createElement("div");ke.className="timeline-progress-track";const qe=document.createElement("div");qe.className="timeline-progress-fill",ke.appendChild(qe);const je=document.createElement("div");je.className="timeline-progress-markers",We.appendChild(ke),We.appendChild(je),Fe.appendChild(We),Le.appendChild(Fe),Ce.appendChild(Le);const Oe=document.createElement("div");Oe.className="timeline-endless-hud is-hidden",Oe.innerHTML='<div class="timeline-endless-pill timeline-endless-lives" aria-label="Lives"><img class="timeline-endless-heart" src="/img/heart.png" alt=""><img class="timeline-endless-heart" src="/img/heart.png" alt=""><img class="timeline-endless-heart" src="/img/heart.png" alt=""></div><div class="timeline-endless-pill timeline-endless-distance"><span class="timeline-endless-distance-value">0m</span></div>',Ce.appendChild(Oe);const Ne=Oe.querySelector(".timeline-endless-distance-value"),Be=Array.from(Oe.querySelectorAll(".timeline-endless-heart"));let _e=3;const $e=()=>{for(let e=0;e<Be.length;e++)e<_e?Be[e].classList.remove("is-dead"):Be[e].classList.add("is-dead")};$e();const Ge=()=>{Le.classList.remove("is-hidden")},Ie=()=>{Le.classList.add("is-hidden")},Ue=()=>{Oe.classList.remove("is-hidden")},Xe=()=>{Oe.classList.add("is-hidden")};m=document.createElement("div"),m.className="timeline-hint is-hidden",m.innerHTML='<div class="timeline-hint-text">Scroll to auto-move â€¢ WASD to steer</div><div class="timeline-hint-swipe" aria-hidden="true"><div class="timeline-hint-swipe-track"></div><div class="timeline-hint-swipe-hand"><svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false"><path d="M7 12V7.5a1.5 1.5 0 0 1 3 0V11h1V6.5a1.5 1.5 0 0 1 3 0V11h1V7.5a1.5 1.5 0 0 1 3 0V14c0 4-2.5 6.5-6.5 6.5H12c-3.7 0-5.5-2.6-5.5-5.5V12a1.5 1.5 0 0 1 3 0v2h-1.5V12"/></svg></div></div>',E&&m.classList.add("is-hidden"),Ce.appendChild(m),p=m.querySelector(".timeline-hint-text"),h=p?.textContent??"";const Ye=(e,t=2e3)=>{if(!m||!p)return;u&&(clearTimeout(u),u=0);const a="undefined"!=typeof performance?performance.now():Date.now();f=a+t,p.textContent=e,m.classList.remove("is-hidden"),u=window.setTimeout(()=>{u=0,f=0,m&&p&&(window.setTimeout(()=>{p.textContent=h},500),(E||ft)&&m.classList.add("is-hidden"))},t)},Qe=document.createElement("div");Qe.className="timeline-marker-info is-hidden",Qe.innerHTML='<div class="timeline-marker-info-inner"><div class="timeline-marker-info-date"></div><div class="timeline-marker-info-title"></div><div class="timeline-marker-info-desc"></div></div>',Ce.appendChild(Qe);const Je=Qe.querySelector(".timeline-marker-info-date"),Ke=Qe.querySelector(".timeline-marker-info-title"),Ze=Qe.querySelector(".timeline-marker-info-desc");let et=-1;const tt=[];let at=0;const nt=e=>{if(null==e||e<0||e>=tt.length)return et=-1,Qe.classList.add("is-hidden"),Qe.classList.remove("is-animating"),void(at&&(clearTimeout(at),at=0));if(et===e)return;et=e;const t=tt[e];Je&&(Je.textContent=t.date),Ke&&(Ke.textContent=t.title),Ze&&(Ze.textContent=t.desc),Qe.classList.remove("is-hidden"),Qe.classList.remove("is-animating"),Qe.offsetWidth,Qe.classList.add("is-animating"),at&&clearTimeout(at),at=window.setTimeout(()=>{at=0,Qe.classList.remove("is-animating")},280)},rt=[],ot=e=>{const t=a.scrollHeight-a.clientHeight,n=Math.max(0,Math.min(t,e*t));try{a.scrollTo({top:n,behavior:"smooth"})}catch{a.scrollTop=n}r()},st=()=>{const e=Fe.clientWidth||0,t=Math.max(e,120+90*Ve);We.style.width=`${t}px`};let it=!1,lt=null,ct=0,dt=0;const mt=e=>{e.isPrimary&&(g(),it=!0,lt=e.pointerId,ct=e.clientY,dt=a.scrollTop,Pe.setPointerCapture(e.pointerId),e.preventDefault())},pt=e=>{if(!it||e.pointerId!==lt)return;const t=e.clientY-ct;a.scrollTop=dt-3*t,e.preventDefault()},ht=e=>{it&&e.pointerId===lt&&(it=!1,lt=null,e.preventDefault())},ut=e=>{if(it)return;g();let t=e.deltaY;1===e.deltaMode?t*=16:2===e.deltaMode&&(t*=window.innerHeight),a.scrollTop+=t,e.preventDefault()};Pe.addEventListener("pointerdown",mt),Pe.addEventListener("pointermove",pt),Pe.addEventListener("pointerup",ht),Pe.addEventListener("pointercancel",ht),Pe.addEventListener("wheel",ut,{passive:!1});for(let jn=0;jn<Ve;jn++){const On=document.createElement("div");On.className="timeline-progress-marker-wrap";const Nn=document.createElement("div");Nn.className="timeline-progress-marker",Nn.style.setProperty("--scale","1");const Bn=document.createElement("div");Bn.className="timeline-progress-label",Bn.textContent=String(e[jn]?.date??""),On.appendChild(Nn),On.appendChild(Bn),je.appendChild(On);const _n=(jn+1)/(Ve+ze),$n=Ae>1e-8?THREE.MathUtils.clamp(_n/Ae,0,1):0;On.style.setProperty("--pos",String($n)),On.addEventListener("pointerdown",e=>{e.preventDefault(),g(),ft&&gt(!1),v=!1,T=!0;let t=$n;try{const e=Rt.getLength(),a=e>1e-6?Ht/e:0,n=THREE.MathUtils.clamp(_n-a,0,Ae);t=Ae>1e-8?THREE.MathUtils.clamp(n/Ae,0,1):0}catch{}ot(t)}),rt.push({marker:Nn,label:Bn,pos:$n})}queueMicrotask(st);let ft=!1;const Et=()=>{Ee&&(ft?(Ie(),m&&m.classList.add("is-hidden"),Ue()):(Ge(),Xe()))},gt=e=>{const t=!!e;t!==ft&&(ft=t,Et())},yt=new THREE.Vector3;let Mt=!1;const wt=()=>{if(!Ne||!Xt)return;Mt||(yt.copy(Xt.position),Mt=!0);const e=Xt.position.x-yt.x,t=Xt.position.z-yt.z;Ne.textContent=`${Math.floor(Math.sqrt(e*e+t*t)/10)}m`};let vt=0,Tt=0;const xt=se()*Math.PI*2;for(let Gn=0;Gn<Ve+ze;Gn++){const In=-(Gn+1)*Se,Un=.08*(3*Math.sin(.035*(Gn+1)+xt)-Tt)+.1*(se()-.5)-.0016*vt;Tt=THREE.MathUtils.clamp(Tt+Un,-.9,.9),vt+=Math.sin(Tt)*Se*.9,vt*=.995;const Xn=vt+3*(se()-.5),Yn=5*Math.sin(1*Gn)+5*(se()-.5);be=new THREE.Vector3(Xn,Yn,In),De.push(be)}const Rt=new THREE.CatmullRomCurve3(De);Rt.tension=.5,Rt.type="catmullrom";const Ht=15,Dt=12,St=200,bt=createRoadGeometry(Rt,St,Dt),Vt=createRoadTexture();Vt.wrapS=THREE.RepeatWrapping,Vt.wrapT=THREE.RepeatWrapping,Vt.repeat.set(1,20),Vt.anisotropy=16,Vt.generateMipmaps=!1,Vt.minFilter=THREE.LinearFilter,Vt.magFilter=THREE.LinearFilter;const zt=new THREE.MeshBasicMaterial({map:Vt,color:16777215,side:THREE.DoubleSide});applyRoadShader(zt);const At=new THREE.Mesh(bt,zt);At.position.y=-2,le.add(At);const Ct=new THREE.Vector3,Pt=new THREE.Vector3,Lt=De.length,Ft=St;let Wt=Lt-1,kt=St,qt=2*kt,jt=new Float32Array(qt+1),Ot=new Float32Array(qt+1),Nt=new Float32Array(qt+1);const Bt=(e=null)=>{Rt.points=De,Rt.updateArcLengths(),kt=e??Math.min(2e3,Math.max(200,Math.floor(6*(De.length-1))));const t=createRoadGeometry(Rt,kt,Dt);At.geometry.dispose(),At.geometry=t,qt=2*kt,jt=new Float32Array(qt+1),Ot=new Float32Array(qt+1),Nt=new Float32Array(qt+1);for(let e=0;e<=qt;e++){const t=e/qt;Rt.getPointAt(t,Ct),jt[e]=Ct.x,Ot[e]=Ct.y,Nt[e]=Ct.z}},_t=(e,t)=>{const a=43758.5453*Math.sin(12.9898*e+78.233*t+y);return a-Math.floor(a)};let $t=vt,Gt=Tt;const It=_t(Wt,9)*Math.PI*2,Ut=e=>{for(let t=0;t<e;t++){const e=++Wt,t=-(e+1)*Se,a=_t(e,3),n=_t(e,4),r=.08*(.65*Math.sin(.035*(e+1)+It)-Gt)+.05*(a-.5)-.0016*$t;Gt=THREE.MathUtils.clamp(Gt+r,-.9,.9),$t+=Math.sin(Gt)*Se*.9,$t*=.995;const o=$t+3*(_t(e,8)-.5),s=5*Math.sin(1*e)+2*(n-.5);De.push(new THREE.Vector3(o,s,t))}};Bt(Ft);let Xt=null;const Yt=new GLTFLoader,Qt=xe();Yt.load("/3d/car.glb",e=>{try{Xt=e.scene,Xt.scale.set(6,6,6),Xt.rotateY(Math.PI),Xt.traverse(e=>{if(e.isMesh&&(e.castShadow=!1,e.receiveShadow=!1,e.material)){const t=e.material,a=new THREE.MeshBasicMaterial({color:t.color,map:t.map,side:t.side,transparent:t.transparent,opacity:t.opacity});e.material=a}}),le.add(Xt)}catch(e){console.error("Error applying car model:",e)}finally{Qt()}},void 0,e=>{console.error("Error loading car:",e),Qt()});const Jt=20,Kt=new THREE.SphereGeometry(.3,7,5),Zt=new THREE.MeshBasicMaterial({color:14540253,flatShading:!0}),ea=[],ta=ie({create:()=>{const e=new THREE.Mesh(Kt,Zt.clone());return le.add(e),{mesh:e,life:0,maxLife:1,velocity:new THREE.Vector3}},onAcquire:e=>{e.mesh.visible=!0,e.life=0},onRelease:e=>{e.mesh.visible=!1,e.life=0},initialSize:Jt}),aa=[],na=new THREE.Group;le.add(na);const ra=new THREE.Group;ra.visible=!0,na.add(ra);let oa=null,sa=null;const ia=ie({create:()=>oa?oa.clone():null,onAcquire:e=>{e.parent||ra.add(e),e.visible=!1},onRelease:e=>{e.visible=!1}}),la=ie({create:()=>sa?sa.clone():null,onAcquire:e=>{e.parent||ra.add(e),e.visible=!1},onRelease:e=>{e.visible=!1}}),ca=[],da=new Set;let ma=0,pa=0,ha=0,ua=!1;const fa=e=>{if(e.userData&&e.userData.vegMaterialCache)return e.userData.vegMaterialCache;const t=[];e.traverse(e=>{if(!e.isMesh)return;if(e.userData=e.userData||{},!e.userData.vegMaterialCloned){const t=e.material;Array.isArray(t)?e.material=t.map(e=>e?e.clone():e):t&&(e.material=t.clone()),e.userData.vegMaterialCloned=!0}const a=e.material;if(Array.isArray(a))for(const e of a)e&&t.push(e);else a&&t.push(a)});for(const e of t)e.userData=e.userData||{},null==e.userData.vegBaseOpacity&&(e.userData.vegBaseOpacity=null==e.opacity?1:e.opacity),e.transparent=!0;return e.userData=e.userData||{},e.userData.vegMaterialCache=t,t},Ea=(e,t)=>{const a=fa(e),n=THREE.MathUtils.clamp(t,0,1);for(const e of a){const t=e.userData?.vegBaseOpacity??1;e.opacity=t*n}},ga=e=>{e.visible=!1,e.userData=e.userData||{},e.userData.vegAppear=0,e.userData.vegAppearDir=1,e.userData.vegTargetScale=1,Ea(e,0)},ya=(e,t)=>{e.userData=e.userData||{},e.userData.vegAppear=0,e.userData.vegAppearDir=1,e.userData.vegTargetScale=t,e.visible=!0,Ea(e,0),e.scale.setScalar(Math.max(.001,.15*t))},Ma=new THREE.Raycaster,wa=new THREE.Vector3(0,-1,0),va=e=>{const t=43758.5453*Math.sin(e);return t-Math.floor(t)},Ta=e=>("tree"===e?ia:la).acquire(),xa=(e,t)=>{("tree"===e?ia:la).release(t)},Ra=()=>{for(const e of ca)da.delete(e.key),xa(e.type,e.obj);ca.length=0,ma=0,pa=0},Ha=520,Da=90,Sa=220,ba=260,Va=260,za=4,Aa=7,Ca=40,Pa=14,La=900,Fa=La*La,Wa=24,ka=50,qa=90,ja=(e,t,a)=>{const n=THREE.MathUtils.clamp((a-e)/(t-e),0,1);return n*n*(3-2*n)},Oa=(e,t)=>{for(let a=ca.length-1;a>=0;a--){const n=ca[a],r=n.obj.position.x-e,o=n.obj.position.z-t;r*r+o*o>Fa&&(n.obj.userData=n.obj.userData||{},n.obj.userData.vegAppearDir=-1)}},Na=e=>{const t=.08*e,a=.12*e;for(let e=ca.length-1;e>=0;e--){const n=ca[e];n.obj.userData=n.obj.userData||{};const r=n.obj.userData.vegAppearDir??1,o=n.obj.userData.vegTargetScale??1;let s=n.obj.userData.vegAppear??0;s=THREE.MathUtils.clamp(s+(r>=0?t:-a),0,1),n.obj.userData.vegAppear=s;const i=s*s*(3-2*s),l=me.position.x-n.obj.position.x,c=me.position.y-n.obj.position.y,d=me.position.z-n.obj.position.z,m=Math.sqrt(l*l+c*c+d*d),p=1-ja(ka,qa,m);Ea(n.obj,i*p),n.obj.scale.setScalar(Math.max(.001,o*(.15+.85*i))),r<0&&s<=1e-4&&(da.delete(n.key),xa(n.type,n.obj),ca.splice(e,1))}},Ba=(e,t,a)=>{if(!oa&&!sa)return e;if(t===e)return e;const n=Math.max(0,Math.min(qt,e)),r=Math.max(0,Math.min(qt,t)),o=r>=n?1:-1;let s=0,i=n;for(;o>0?i<=r:i>=r;i+=o*Wa){const e=Math.floor((va(17.71*i+y)-.5)*(.6*Wa)),t=Math.max(0,Math.min(qt,i+e));for(let e=0;e<3;e++){const a=Math.max(0,Math.min(qt,t+e*za)),n=a/qt;Rt.getPointAt(n,J),Rt.getTangentAt(n,K).normalize(),Z.crossVectors(K,vn).normalize();const r=va(78.233*a+y)>.5?1:-1,o=va(41.17*a+y),i=Ua+6+38*o,l=J.x+Z.x*(r*i),c=J.z+Z.z*(r*i)+18*(va(19.19*a+y)-.5),d=`${Math.round(l/Pa)},${Math.round(c/Pa)}`;if(da.has(d))continue;const m="grass"===_a(l,c)?"tree":"cactus",p=Ta(m);if(!p)continue;ga(p),Ma.set(_.set(l,50,c),wa);const h=Ma.intersectObjects([an,nn],!1);let u=-2;h.length>0&&(u=h[0].point.y);let f=1;"tree"===m?(p.position.set(l,u+4.25,c),f=4+5*va(3.11*a+y)):(p.position.set(l,u,c),f=4+2*va(3.11*a+y)),p.rotation.y=va(2.71*a+y)*Math.PI*2,ya(p,f),da.add(d),ca.push({type:m,obj:p,key:d}),s++;break}if(s>=a)break}return i},_a=(e,t)=>Math.sin(.025*(e+y))+Math.cos(.025*(t+y)*.7)+(.1*Math.sin(.05*(e+y))+.1*Math.cos(.05*(t+y)))>.2?"grass":"desert",$a=(e,t)=>"grass"===_a(e,t)?10207788:16436245,Ga=100,Ia=100,Ua=Dt/2,Xa=10,Ya=(e,t,a,n)=>{const r=new THREE.BufferGeometry,o=[],s=[],i=[],l=new THREE.Vector3(0,1,0),c=Xa;for(let r=0;r<=t;r++){const i=r/t,d=e.getPointAt(i),m=e.getTangentAt(i).normalize(),p=(new THREE.Vector3).crossVectors(m,l).normalize();for(let e=0;e<=c;e++){const t=e/c,i=a+(n-a)*t,l=(new THREE.Vector3).copy(d).add(p.clone().multiplyScalar(i)),m=_a(l.x,l.z),h=$a(l.x,l.z),u=new THREE.Color(h);let f=0;if(t>.1){const a=(t-.1)/.9,n=5*Math.sin(.1*r+.5*e+y),o=10*Math.cos(.3*r+.2*e+y),s=20*Math.sin(.05*r+y);let i=Math.abs(n+o+s);"desert"===m?(i*=.8,i=Math.abs(15*Math.sin(.2*r+1*e+y))):i*=1.2,f=i*a}l.y+=f,o.push(l.x,l.y,l.z);const E=43758.5453*Math.sin(12.9898*r+78.233*e+y),g=.01*(E-Math.floor(E)-.5);u.addScalar(g),s.push(u.r,u.g,u.b)}}const d=c+1;for(let e=0;e<t;e++)for(let t=0;t<c;t++){const a=e*d+t,n=e*d+t+1,r=(e+1)*d+t,o=(e+1)*d+t+1;i.push(a,n,o),i.push(a,o,r)}return r.setAttribute("position",new THREE.Float32BufferAttribute(o,3)),r.setAttribute("color",new THREE.Float32BufferAttribute(s,3)),r.setIndex(i),r.computeVertexNormals(),r},Qa=Ya(Rt,St,-Ua,-(Ua+Ia)),Ja=Ya(Rt,St,Ua,Ua+Ia),Ka=new THREE.MeshBasicMaterial({vertexColors:!0,side:THREE.DoubleSide}),Za=64,en=Array.from({length:Za},()=>new THREE.Vector3(1e9,0,1e9));let tn=0;Ka.userData=Ka.userData||{},Ka.userData.signShadowMax=Za,Ka.userData.signShadowPositions=en,Ka.userData.uniforms=Ka.userData.uniforms||{},Ka.userData.uniforms.signCount={value:0},Ka.userData.uniforms.signPos={value:en},applyFadeToMaterial(Ka);const an=new THREE.Mesh(Qa,Ka),nn=new THREE.Mesh(Ja,Ka);an.position.y=-2.1,nn.position.y=-2.1,le.add(an),le.add(nn);const rn=(e=null)=>{const t=e??kt,a=Ya(Rt,t,-Ua,-(Ua+Ia)),n=Ya(Rt,t,Ua,Ua+Ia);an.geometry.dispose(),nn.geometry.dispose(),an.geometry=a,nn.geometry=n},on=e=>new Promise(t=>{const a=xe();Yt.load(e,n=>{try{const e=n.scene;e.traverse(e=>{if(e.isMesh&&e.material){const t=e.material,a=new THREE.MeshBasicMaterial({color:t.color,map:t.map,side:t.side,transparent:!0});applyFadeToMaterial(a),e.material=a}}),t(e)}catch(a){console.error(`Error applying ${e}`,a),t(null)}finally{a()}},void 0,n=>{console.error(`Error loading ${e}`,n),t(null),a()})});function n(e,t){e.traverse(e=>{if((e.isMesh||e.isSprite)&&e.material)if(Array.isArray(e.material))for(const a of e.material){if(!a)continue;a.userData||(a.userData={}),null==a.userData.baseOpacity&&(a.userData.baseOpacity=a.opacity??1),null==a.userData.baseTransparent&&(a.userData.baseTransparent=!!a.transparent),null==a.userData.baseDepthWrite&&(a.userData.baseDepthWrite=a.depthWrite??!0);const e=a.userData.baseOpacity*t;a.opacity=e,t<.999?(a.transparent=!0,a.depthWrite=!1):(a.transparent=a.userData.baseTransparent,a.depthWrite=a.userData.baseDepthWrite)}else{const a=e.material;a.userData||(a.userData={}),null==a.userData.baseOpacity&&(a.userData.baseOpacity=a.opacity??1),null==a.userData.baseTransparent&&(a.userData.baseTransparent=!!a.transparent),null==a.userData.baseDepthWrite&&(a.userData.baseDepthWrite=a.depthWrite??!0);const n=a.userData.baseOpacity*t;a.opacity=n,t<.999?(a.transparent=!0,a.depthWrite=!1):(a.transparent=a.userData.baseTransparent,a.depthWrite=a.userData.baseDepthWrite)}})}Promise.all([on("/3d/tree.glb"),on("/3d/cactus.glb")]).then(([e,t])=>{oa=e,sa=t,an.updateMatrixWorld(),nn.updateMatrixWorld(),Ra();const a=new THREE.Raycaster,n=new THREE.Vector3(0,-1,0);for(let e=0;e<Ga;e++){const t=e/Ga,r=Rt.getPointAt(t),o=1;for(let e=0;e<o;e++){const e=Ua+5,t=Ua+40,o=e+se()*(t-e),s=se()>.5?1:-1,i=r.x+s*o,l=r.z+20*(se()-.5);a.set(new THREE.Vector3(i,50,l),n);const c=a.intersectObjects([an,nn]);let d=-2;c.length>0&&(d=c[0].point.y);const m=_a(i,l);if("grass"===m&&oa){if(se()>.6){const e=oa.clone();e.position.set(i,d+4.25,l),e.rotation.y=se()*Math.PI*2;const t=4+5*se();e.scale.setScalar(t),na.add(e)}}else if("desert"===m&&sa&&se()>.5){const e=sa.clone();e.position.set(i,d,l),e.rotation.y=se()*Math.PI*2;const t=4+2*se();e.scale.setScalar(t),na.add(e)}}}});const sn=e=>{const t=String(e??"");try{return(new DOMParser).parseFromString(t,"text/html").body.textContent||""}catch{return t.replace(/<[^>]*>/g,"")}};e.forEach((e,t)=>{const a=(t+1)/(De.length-1),r=Rt.getPointAt(a),o=Rt.getTangentAt(a).normalize(),s=new THREE.Vector3(0,1,0);let i=(new THREE.Vector3).crossVectors(o,s).normalize();const l=Math.min(1,a+.05),c=Rt.getTangentAt(l).normalize(),d=o.x*c.z-o.z*c.x;let m=d>0?1:-1;Math.abs(d)<.01&&(m=t%2==0?1:-1);const p=m*(.5*Dt+.8),h=r.clone().add(i.multiplyScalar(p));_.set(h.x,50,h.z),N.set(_,B);let u=-2;const f=N.intersectObjects([an,nn,At],!1);f.length>0&&(u=f[0].point.y),h.y=u,tn<en.length&&(en[tn].set(h.x,u,h.z),tn+=1);const E=new THREE.Group;var g;E.position.copy(h),le.add(E),aa.push(E),(g=E).userData&&g.userData.fadePrepared||(g.userData||(g.userData={}),g.userData.fadePrepared=!0,g.traverse(e=>{if(!e.isMesh&&!e.isSprite)return;const t=e.material;if(t)if(Array.isArray(t)){const a=t.map(e=>{if(!e)return e;const t=e.clone();return t.userData||(t.userData={}),null==t.userData.baseOpacity&&(t.userData.baseOpacity=t.opacity??1),t.transparent=!0,t.depthWrite=!1,t});e.material=a}else{const a=t.clone();a.userData||(a.userData={}),null==a.userData.baseOpacity&&(a.userData.baseOpacity=a.opacity??1),a.transparent=!0,a.depthWrite=!1,e.material=a}})),n(E,1);const M=e=>2*((e=>{const t=43758.5453*Math.sin(e);return t-Math.floor(t)})(97.31*(t+1)+e+y)-.5),w=new THREE.Group;w.position.set(0,0,0),G.copy(r),G.y=h.y,w.lookAt(G),w.rotateY(Math.PI),w.scale.setScalar(1.5),E.add(w);const v=new THREE.CylinderGeometry(.08,.1,3,8),T=new THREE.MeshBasicMaterial({color:10265519}),x=new THREE.Mesh(v,T);x.position.y=-1.5,x.position.z=-.1,w.add(x);const R=1.6,H=sn(e.text).replace(/\s+/g," ").trim(),D=createMileMarkerTexture(String(e.date??""),H,{width:360}),S=R*(D?.image?.width&&D?.image?.height?D.image.height/D.image.width:2.2),b=D?.userData?.cornerRadius01,V=createRoundedRectShape(R,S,"number"==typeof b&&Number.isFinite(b)?R*b:Math.min(.288,.09*S)),z=new THREE.ExtrudeGeometry(V,{depth:.1,bevelEnabled:!1,steps:1});z.translate(0,0,-.05);const A=new THREE.MeshBasicMaterial({color:744734,side:THREE.DoubleSide}),C=new THREE.Mesh(z,A);C.renderOrder=1;const P=new THREE.ShapeGeometry(V);normalizeShapeUvs(P);const L=new THREE.MeshBasicMaterial({map:D,transparent:!0,alphaTest:.05,side:THREE.DoubleSide}),F=new THREE.Mesh(P,L);F.position.z=.05+.001,F.renderOrder=2;const W=new THREE.Group;W.add(C),W.add(F),W.position.set(0,.5*S+.06,.18),W.rotation.z=.03*M(5.55),W.rotation.x=.02*M(6.66),w.add(W);const k=sn(`${e.left??""} ${e.right??""}`).replace(/\s+/g," ").trim();tt.push({t:a,date:String(e.date??""),title:H,desc:k})}),Ka.userData.uniforms&&Ka.userData.uniforms.signCount&&(Ka.userData.uniforms.signCount.value=tn);let ln=0,cn=-1,dn=!1,mn=0;function r(){const e=a.scrollTop,t=cn>=0?Math.abs(e-cn):0;t>3&&(mn=30),t>3&&g(),Math.abs(e-cn)>1&&(cn=e);const n=a.scrollHeight-a.clientHeight,r=n>0?Math.max(0,Math.min(1,e/n)):0;dn=n>0&&e>=n-2,ln=r*Ae}a.addEventListener("scroll",r),r();const pn=new THREE.Clock,hn=new THREE.Vector3,un=new THREE.Vector3,fn=new THREE.Vector3,En=new THREE.Vector3,gn=new THREE.Vector3,yn=new THREE.Quaternion,Mn=new THREE.Matrix4,wn=new THREE.Vector3,vn=new THREE.Vector3(0,1,0),Tn=new THREE.Vector3,xn=new THREE.Vector3,Rn=new THREE.Vector3,Hn=new THREE.Vector3,Dn=new THREE.Vector3,Sn=new THREE.Vector3,bn=new THREE.Vector3,Vn=new THREE.Vector3,zn=new THREE.Vector3,An=new THREE.Vector3,Cn=new THREE.Vector3,Pn=new THREE.Vector3,Ln=new THREE.Vector3(0,1,0);let Fn=1,Wn=!1,kn=0;!function e(){if(ue)return;fe=requestAnimationFrame(e);const t=pn.getDelta(),a=60*t;mn>0&&mn--;const r=.05*(ln-kn);kn+=r;const o=Rt.getLength();let s=0;const i=Ht/o,l=Math.min(1,kn+i);if(Xt){let e=Math.floor(l*qt);const t=w.w||w.a||w.s||w.d||w.arrowup||w.arrowdown||w.arrowleft||w.arrowright;t||(T=!0),!v&&t&&T&&(v=!0,T=!1),v&&!ft&&mn>0&&!t&&(v=!1);const n=v&&!Wn;if(n&&(R.copy(Xt.position),A.set(0,0,0),S=0,D=0,ha=45,x=!0,W=!0,k=!1,q.copy(R),q.y=0,Xt.getWorldDirection(te),te.y=0,te.lengthSq()>1e-8&&(te.normalize(),H=Math.atan2(-te.x,-te.z))),v){Ln.set(0,1,0);let t=R.y,r=!1,o=1/0,i=0,l=0;const c=R.x,d=R.z;for(let e=0;e<qt;e++){const t=jt[e],a=Nt[e],n=jt[e+1]-t,r=Nt[e+1]-a,s=n*n+r*r;if(s<1e-8)continue;let m=((c-t)*n+(d-a)*r)/s;m<0?m=0:m>1&&(m=1);const p=c-(t+n*m),h=d-(a+r*m),u=p*p+h*h;u<o&&(o=u,i=e,l=m)}const m=jt[i],p=Nt[i],h=Ot[i],u=jt[i+1],f=Nt[i+1],E=Ot[i+1],g=u-m,y=f-p;F=(i+l)/qt,e=i,G.set(m+g*l,h+(E-h)*l,p+y*l),U.set(g,0,y),U.lengthSq()<1e-8?U.set(0,0,-1):U.normalize(),n&&W&&(j.copy(U),k=!0),I.copy(U),te.set(0,0,-1).applyAxisAngle(vn,H),te.y=0,te.lengthSq()>1e-8?te.normalize():te.set(0,0,-1),I.dot(te)<0&&I.negate(),X.crossVectors(I,vn).normalize(),n?oe.copy(I):(re.copy(I),re.dot(oe)<0&&re.negate(),oe.lerp(re,Math.min(1,.25*a)).normalize()),Y.copy(R).sub(G);const M=.5*Dt-1.5,v=Y.dot(X),T=THREE.MathUtils.clamp(v,-M,M);if((!n||Math.abs(v)>M)&&(R.x=G.x+X.x*T,R.z=G.z+X.z*T),k){Q.copy(R).sub(q),Q.y=0;const e=Q.dot(j);if(e<0){R.addScaledVector(j,-e);const t=A.dot(j);t<0&&A.addScaledVector(j,-t)}}if(v>M){const e=A.dot(X);e>0&&A.addScaledVector(X,-e)}else if(v<-M){const e=A.dot(X);e<0&&A.addScaledVector(X,-e)}{const e=A.dot(I);if(F>.82&&e>.02){Ut(30);const e=De.length-Lt;if(e>Ha&&F>.45){const t=Math.floor(F*(De.length-1)),a=Math.max(0,t-Lt),n=e-(Da+6),r=Math.max(0,Math.min(a-Da,n));r>0&&De.splice(Lt,r)}Bt(),rn(),ha=45,ua=!0}}_.set(R.x,50,R.z),N.set(_,B);const J=N.intersectObject(At);if(J.length>0&&(r=!0,t=J[0].point.y+O,J[0].face&&($.copy(J[0].face.normal).transformDirection(J[0].object.matrixWorld),Ln.copy($))),Ln.y<0&&Ln.negate(),P.lerp(Ln,Math.min(1,.08*a)).normalize(),x&&r&&(R.y=t,A.y=0,x=!1),r){const e=t-R.y;if(e>0){const t=.35*a;R.y+=Math.min(e,t),A.y<0&&(A.y=0)}}const K=V*a,Z=w.w||w.arrowup,ee=w.s||w.arrowdown;if(ft)S=Math.min(S+K,b);else if(Z&&!ee)S=Math.min(S+K,b);else if(ee&&!Z)S=Math.max(S-K,-b);else{const e=Math.pow(z,a);S*=e,Math.abs(S)<1e-4&&(S=0)}{const e=Math.PI/6,t=Math.hypot(A.x,A.z),n=Math.min(1,t/1.2),r=(w.a||w.arrowleft?1:0)+(w.d||w.arrowright?-1:0);D+=r*(.12*(.35+.65*n)*a),0===r&&(D*=Math.pow(.85,a)),D=THREE.MathUtils.clamp(D,-e,e);H+=D*(.08*n*a)*(S<0?-1:1)}te.set(0,0,-1).applyAxisAngle(vn,H).normalize();const se=te,ie=r&&R.y<=t+.05;if(ie&&se.projectOnPlane(P).normalize(),A.addScaledVector(se,.12*S*a),ie){const e=Math.hypot(A.x,A.z);if(e>1e-4){const t=Math.min(1,e/1.2);if(ae.set(A.x,0,A.z).multiplyScalar(1/e),ne.copy(se),S<0&&ne.negate(),ne.y=0,ne.lengthSq()>1e-8){ne.normalize();const n=(.12+.45*t)*a;ae.lerp(ne,Math.min(1,n)).normalize(),A.x=ae.x*e,A.z=ae.z*e}}}const le=Math.pow(.87,a);if(A.x*=le,A.z*=le,A.y*=Math.pow(.99,a),A.y-=L*a,R.addScaledVector(A,a),r&&R.y<t&&(R.y=t,A.y<0&&(A.y=0),A.dot(P)<0&&A.projectOnPlane(P)),C=r&&R.y<=t+.05,C){A.y<0&&(A.y=0);const e=P.angleTo(vn);e>.05&&(Tn.copy(B).projectOnPlane(P).normalize(),A.addScaledVector(Tn,.01*e*a))}Xt.position.copy(R);const ce=C?P:vn;wn.copy(R).addScaledVector(se,-1),Mn.lookAt(R,wn,ce),yn.setFromRotationMatrix(Mn),Xt.quaternion.slerp(yn,Math.min(1,.15*a)),xn.copy(R),s=A.length()}else{Rt.getPointAt(l,Ct),Rt.getTangentAt(l,Pt).normalize(),Hn.crossVectors(Pt,vn).normalize();const t=60,a=3,n=Math.sin(l*t)*a;xn.copy(Ct).addScaledVector(Hn,n),_.set(xn.x,50,xn.z),N.set(_,B);const i=N.intersectObject(At);i.length>0?xn.y=i[0].point.y+O:xn.y-=1.3,S=0,A.set(0,0,0),F=l,s=Math.abs(r)*o;const c=Math.min(1,l+.005),d=Math.sin(c*t)*a;Rt.getPointAt(c,Rn),Rt.getTangentAt(c,Dn).normalize(),Sn.crossVectors(Dn,vn).normalize(),Rn.addScaledVector(Sn,d),_.set(Rn.x,50,Rn.z),N.set(_,B);const m=N.intersectObject(At);m.length>0?Rn.y=m[0].point.y+O:Rn.y-=1.5,R.copy(xn),e=Math.floor(l*qt),Rn.distanceToSquared(xn)>1e-4&&(Xt.position.copy(xn),Xt.lookAt(Rn)),Xt.getWorldDirection(te),te.y=0,te.lengthSq()>1e-8&&(te.normalize(),H=Math.atan2(te.x,-te.z))}const i=Ae>1e-8?F/Ae:0;if(!ft&&v&&i>=.9999&&(gt(!0),_e=3,$e(),Ye("Endless Mode",1800)),!ft){const e=THREE.MathUtils.clamp(i,0,1);qe.style.transform=`scaleX(${e})`;{const t=Fe.clientWidth,a=We.scrollWidth;if(a>t+1){const n=a-t,r=THREE.MathUtils.clamp(e*n,0,n);We.style.transform=`translateX(-${r}px)`}else We.style.transform="translateX(0)"}for(const t of rt){const a=Math.abs(e-t.pos),n=Math.max(0,1-10*a),r=1+1.4*n;t.marker.style.setProperty("--scale",String(r)),t.label.style.opacity=String(.65+.35*n)}}{const t=Math.max(0,e-Sa),n=Math.min(qt,e+ba),r=Math.min(qt,n+Va);if(ee.copy(Xt.position),Oa(ee.x,ee.z),Na(a),ca.length||0!==ma||0!==pa||(ma=e,pa=e),ua&&(ma=e,pa=e,ua=!1),ma=Math.max(e,Math.min(r,ma)),pa=Math.max(t,Math.min(e,pa)),oa||sa){const a=Math.max(0,(r-ma)/Wa),n=Math.min(55,Math.floor(.4*a)),o=Aa+n+(ha>0?28:0),s=ha>0?Math.min(r,e+ba+Ca):r;ma<=s&&(ma=Ba(ma,s,o));const i=Math.max(0,(pa-t)/Wa),l=Math.min(18,Math.floor(.25*i));pa>=t&&(pa=Ba(pa,t,(ha>0?2:4)+l)),ha>0&&ha--}}const c=Math.min(1.5*s,2),d=.001*Date.now();Vn.copy(xn),Xt.position.copy(Vn),wt(),v||(Rt.getTangentAt(l,Pt).normalize(),Hn.crossVectors(Pt,vn).normalize(),bn.crossVectors(Hn,Pt).normalize(),bn.y<0&&bn.negate(),Xt.up.copy(bn));const m=10,p=.1*c,h=1-Math.sin(d*m)*(.5*p),u=(Math.random()-.5)*p,f=(Math.random()-.5)*p,E=6;Xt.scale.set(E*(h+u),E,E*(h+f)),zt.userData.uniforms&&(zt.userData.uniforms.carPos.value.copy(Vn),zt.userData.uniforms.carDir&&(Xt.getWorldDirection(te),te.y=0,te.lengthSq()>1e-8?te.normalize():te.set(0,0,-1),zt.userData.uniforms.carDir.value.set(te.x,te.z)));const g=ne.set(0,0,1).applyQuaternion(Xt.quaternion);let y=0;if(y=(v?A.dot(oe)>.01:r>1e-4)&&s>.01?.1+.5*s:0,Math.random()<y){const e=ta.acquire();if(e){e.maxLife=1+.5*Math.random(),e.life=e.maxLife,Pn.copy(Vn).addScaledVector(g,2.5),e.mesh.position.copy(Pn),e.mesh.position.x+=.3*(Math.random()-.5),e.mesh.position.z+=.3*(Math.random()-.5),e.mesh.scale.set(1,1,1);const t=.5+.5*Math.random();e.mesh.material.color.setScalar(t),ea.push(e)}}for(let e=ea.length-1;e>=0;e--){const t=ea[e];if(t.life-=.03*a,t.life<=0)ea.splice(e,1),ta.release(t);else{t.mesh.position.y+=.02*a;const e=t.life/t.maxLife,n=2.5*(3*e*(1-e));t.mesh.scale.set(n,n,n)}}}if(v)zn.copy(oe),zn.y=0,zn.lengthSq()>1e-8?zn.normalize():zn.set(0,0,-1),An.copy(zn).multiplyScalar(-15),An.y+=5,En.copy(R).add(An),Cn.copy(zn).multiplyScalar(20),gn.copy(R).add(Cn);else{const e=Rt.getPointAt(kn),t=Rt.getPointAt(Math.min(1,kn+.05));En.copy(e),En.y+=2.5,gn.set(t.x,t.y-2+1,t.z)}if(v&&!Wn&&(Fn=0,un.copy(me.position),fn.copy(hn)),v?(Fn=Math.min(1,Fn+3*t),me.position.lerpVectors(un,En,Fn),hn.lerpVectors(fn,gn,Fn)):(Fn=1,me.position.copy(En),hn.copy(gn)),me.lookAt(hn),Wn=v,!ft&&tt.length>0){const e=Xt?F:kn;let t=0,a=1/0;for(let n=0;n<tt.length;n++){const r=Math.abs(tt[n].t-e);r<a&&(a=r,t=n)}nt(t)}else nt(null);aa.forEach(e=>{const t=e.position.distanceTo(me.position);let a=1;t>50&&(a=1-(t-50)/40,a=Math.max(0,Math.min(1,a))),n(e,a)}),he.render(le,me)}();const qn=new ResizeObserver(e=>{for(let t of e)we();st()});qn.observe(t),queueMicrotask(()=>{ye||ue||Te()});return{destroy:()=>{ue||(ue=!0,window.removeEventListener("keydown",Re),window.removeEventListener("keyup",He),a.removeEventListener("scroll",r),Pe.removeEventListener("pointerdown",mt),Pe.removeEventListener("pointermove",pt),Pe.removeEventListener("pointerup",ht),Pe.removeEventListener("pointercancel",ht),Pe.removeEventListener("wheel",ut),qn.disconnect(),Me&&(clearTimeout(Me),Me=0),fe&&cancelAnimationFrame(fe),le.traverse(e=>{if(e.isMesh){e.geometry&&e.geometry.dispose();const t=e.material;if(Array.isArray(t))for(const e of t)e&&e.map&&e.map.dispose(),e&&e.dispose();else t&&(t.map&&t.map.dispose(),t.dispose())}}),Vt&&Vt.dispose(),he.dispose(),he.domElement&&he.domElement.parentNode&&he.domElement.parentNode.removeChild(he.domElement),Ce&&Ce.parentNode&&Ce.parentNode.removeChild(Ce),t.innerHTML="")}}}catch(Qn){return console.error("Error initializing 3D timeline:",Qn),t.innerHTML="Error initializing 3D view: "+Qn.message,t.style.opacity="1",null}}function createRoadGeometry(e,t,a){const n=new THREE.BufferGeometry,r=[],o=[],s=[],i=new THREE.Vector3(0,1,0);for(let n=0;n<=t;n++){const s=n/t,l=e.getPointAt(s),c=e.getTangentAt(s).normalize(),d=(new THREE.Vector3).crossVectors(c,i).normalize().multiplyScalar(a/2),m=(new THREE.Vector3).copy(l).add(d),p=(new THREE.Vector3).copy(l).sub(d);r.push(m.x,m.y,m.z),r.push(p.x,p.y,p.z);const h=n/t;o.push(0,h),o.push(1,h)}for(let e=0;e<t;e++){const t=2*e;s.push(t,t+1,t+2),s.push(t+1,t+3,t+2)}return n.setAttribute("position",new THREE.Float32BufferAttribute(r,3)),n.setAttribute("uv",new THREE.Float32BufferAttribute(o,2)),n.setIndex(s),n.computeVertexNormals(),n}function createRoadTexture(){const e=document.createElement("canvas");e.width=2048,e.height=2048;const t=e.getContext("2d");t.fillStyle="#333333",t.fillRect(0,0,2048,2048),t.fillStyle="#ffffff",t.fillRect(40,0,40,2048),t.fillRect(1968,0,40,2048),t.strokeStyle="#facc15",t.lineWidth=32,t.setLineDash([128,128]),t.beginPath(),t.moveTo(1024,0),t.lineTo(1024,2048),t.stroke();return new THREE.CanvasTexture(e)}function wrapText(e,t,a,n,r,o){const s=t.split(" ");let i="";for(let t=0;t<s.length;t++){const l=i+s[t]+" ";e.measureText(l).width>r&&t>0?(e.fillText(i,a,n),i=s[t]+" ",n+=o):i=l}e.fillText(i,a,n)}function createTextTexture(e,t={}){const a=document.createElement("canvas"),n=a.getContext("2d"),r=t.width||256,o=t.height||128;return a.width=r,a.height=o,n.font=`bold ${t.fontSize||40}px Arial`,n.fillStyle=t.color||"white",n.textAlign="center",n.textBaseline="middle",n.fillText(e,r/2,o/2),new THREE.CanvasTexture(a)}function createMileMarkerTexture(e,t,a={}){const n=a.width??360,r=String(e??"").trim(),o=String(t??"").replace(/\s+/g," ").trim(),s=document.createElement("canvas").getContext("2d"),i=Math.max(20,Math.round(.12*n)),l=Math.max(18,Math.round(.08*n)),c=Math.max(1,n-2*i);let d=Math.max(34,Math.round(.24*n));for(s.font=`800 ${d}px Arial`;d>34&&s.measureText(r).width>c;)d-=2,s.font=`800 ${d}px Arial`;const m=Math.max(10,Math.round(.06*n)),p=1.15*d;let h=0,u=[];o&&(h=Math.max(48,Math.round(.11*n)),s.font=`700 ${h}px Arial`,u=((e,t,a)=>{const n=String(t??"").trim();if(!n)return[];const r=n.split(" "),o=[];let s="";const i=e=>{const t=e.trim();t&&o.push(t)},l=t=>{let n="";for(const r of t){const t=n+r;e.measureText(t).width>a&&n?(i(n),n=r):n=t}i(n)};for(const t of r){const n=s?`${s} ${t}`:t;e.measureText(n).width<=a?s=n:(s&&i(s),s="",e.measureText(t).width<=a?s=t:l(t))}return s&&i(s),o})(s,o,c));const f=h?1.16*h:0,E=u.length?u.length*f:0,g=Math.max(l,Math.round(.35*(d+(h||0)))),y=o?p+m+E:p,M=Math.round(2*g+y),w=document.createElement("canvas"),v=w.getContext("2d");w.width=n,w.height=M,v.clearRect(0,0,n,M),v.fillStyle="#0b5d1e",v.strokeStyle="rgba(255, 255, 255, 0.95)";const T=Math.max(5,Math.round(.03*n)),x=Math.max(10,Math.round(.12*n)),R=.5*T,H=.5*T,D=n-T,S=M-T,b=Math.min(x,.5*D,.5*S);v.beginPath(),v.moveTo(R+b,H),v.arcTo(R+D,H,R+D,H+S,b),v.arcTo(R+D,H+S,R,H+S,b),v.arcTo(R,H+S,R,H,b),v.arcTo(R,H,R+D,H,b),v.closePath(),v.fill(),v.lineWidth=T,v.lineJoin="round",v.lineCap="round",v.stroke(),v.fillStyle="#ffffff",v.textAlign="center",v.textBaseline="alphabetic";const V=.5*n,z=g+d;if(v.font=`800 ${d}px Arial`,v.fillText(r,V,z),o&&u.length){v.font=`700 ${h}px Arial`;let e=z+m+h;for(let t=0;t<u.length;t++)v.fillText(u[t],V,e),e+=f}const A=new THREE.CanvasTexture(w);return A.userData=A.userData||{},A.userData.cornerRadius01=n>0?b/n:0,A.generateMipmaps=!1,A.minFilter=THREE.LinearFilter,A.magFilter=THREE.LinearFilter,A.wrapS=THREE.ClampToEdgeWrapping,A.wrapT=THREE.ClampToEdgeWrapping,A.needsUpdate=!0,A}function createRoundedRectShape(e,t,a){const n=e,r=t,o=Math.max(0,Math.min(a,.5*n,.5*r)),s=.5*-n,i=.5*-r,l=new THREE.Shape;return l.moveTo(s+o,i),l.lineTo(s+n-o,i),l.quadraticCurveTo(s+n,i,s+n,i+o),l.lineTo(s+n,i+r-o),l.quadraticCurveTo(s+n,i+r,s+n-o,i+r),l.lineTo(s+o,i+r),l.quadraticCurveTo(s,i+r,s,i+r-o),l.lineTo(s,i+o),l.quadraticCurveTo(s,i,s+o,i),l}function normalizeShapeUvs(e){e.computeBoundingBox();const t=e.boundingBox;if(!t)return;const a=t.min.x,n=t.min.y,r=Math.max(1e-8,t.max.x-t.min.x),o=Math.max(1e-8,t.max.y-t.min.y),s=e.getAttribute("position");if(!s)return;const i=new Float32Array(2*s.count);for(let e=0;e<s.count;e++){const t=s.getX(e),l=s.getY(e);i[2*e]=(t-a)/r,i[2*e+1]=(l-n)/o}e.setAttribute("uv",new THREE.BufferAttribute(i,2))}function applyFadeToMaterial(e){e.transparent=!0;const t=e.userData?.signShadowMax,a="number"==typeof t&&Number.isFinite(t)&&t>0;a&&(e.defines=e.defines||{},e.defines.SIGN_SHADOW_MAX=Math.max(1,Math.floor(t)),e.userData.uniforms=e.userData.uniforms||{},e.userData.uniforms.signCount||(e.userData.uniforms.signCount={value:0}),e.userData.uniforms.signPos||(e.userData.uniforms.signPos={value:e.userData.signShadowPositions||[]})),e.onBeforeCompile=t=>{a&&(t.uniforms.signCount=e.userData.uniforms.signCount,t.uniforms.signPos=e.userData.uniforms.signPos,t.vertexShader=`\n                varying vec3 vWorldPosition;\n                ${t.vertexShader}\n            `,t.vertexShader=t.vertexShader.replace("#include <project_vertex>","\n                vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n                vWorldPosition = worldPosition.xyz;\n                #include <project_vertex>\n                "),t.fragmentShader=`\n                uniform int signCount;\n                uniform vec3 signPos[SIGN_SHADOW_MAX];\n                varying vec3 vWorldPosition;\n                ${t.fragmentShader}\n            `),t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",`\n            #include <dithering_fragment>\n            ${a?"\n            float signShadow = 0.0;\n            for (int i = 0; i < SIGN_SHADOW_MAX; i++) {\n                if (i < signCount) {\n                    vec2 rel = vWorldPosition.xz - signPos[i].xz;\n                    float d = length(rel);\n                    float radius = 0.525;\n                    float soft = 0.35;\n                    float s = 1.0 - smoothstep(radius, radius + soft, d);\n                    signShadow = max(signShadow, s);\n                }\n            }\n            gl_FragColor.rgb = mix(gl_FragColor.rgb, gl_FragColor.rgb * 0.55, signShadow * 0.6);\n            ":""}\n            float dist = gl_FragCoord.z / gl_FragCoord.w;\n            float fadeStart = 50.0;\n            float fadeEnd = 90.0;\n            float alpha = 1.0 - smoothstep(fadeStart, fadeEnd, dist);\n            gl_FragColor.a *= alpha;\n            `)}}function applyRoadShader(e){e.transparent=!0,e.userData.uniforms={carPos:{value:new THREE.Vector3},carDir:{value:new THREE.Vector2(0,-1)}},e.onBeforeCompile=t=>{t.uniforms.carPos=e.userData.uniforms.carPos,t.uniforms.carDir=e.userData.uniforms.carDir,t.vertexShader=`\n            varying vec3 vWorldPosition;\n            ${t.vertexShader}\n        `,t.vertexShader=t.vertexShader.replace("#include <project_vertex>","\n            vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n            vWorldPosition = worldPosition.xyz;\n            #include <project_vertex>\n            "),t.fragmentShader=`\n            uniform vec3 carPos;\n            uniform vec2 carDir;\n            varying vec3 vWorldPosition;\n            ${t.fragmentShader}\n        `,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>","\n            #include <dithering_fragment>\n            \n            vec2 rel = vWorldPosition.xz - carPos.xz;\n            vec2 f = normalize(carDir);\n            vec2 r = vec2(f.y, -f.x);\n            vec2 local = vec2(dot(rel, r), dot(rel, f));\n\n            vec2 halfSize = vec2(1.3, 2.2);\n            vec2 q = abs(local) - halfSize;\n            float outside = length(max(q, vec2(0.0)));\n            float inside = min(max(q.x, q.y), 0.0);\n            float boxDist = outside + inside;\n\n            float shadowSoft = 0.01;\n            float shadow = 1.0 - smoothstep(0.0, shadowSoft, max(boxDist, 0.0));\n            gl_FragColor.rgb = mix(gl_FragColor.rgb, gl_FragColor.rgb * 0.55, shadow * 0.85);\n            \n            float depth = gl_FragCoord.z / gl_FragCoord.w;\n            float fadeStart = 50.0;\n            float fadeEnd = 90.0;\n            float alpha = 1.0 - smoothstep(fadeStart, fadeEnd, depth);\n            gl_FragColor.a *= alpha;\n            ")}}